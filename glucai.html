<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLucAI Versión: DEMO V1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
        }

        .glass-pane {
            background-color: rgba(13, 17, 23, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(48, 54, 61, 0.5);
            z-index: 10;
        }

        .main-grid {
            grid-template-columns: 350px 1fr;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #161b22;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff;
        }

        .patient-list-item:hover .delete-patient-btn {
            opacity: 1;
        }

        .patient-list-item.active {
            background-color: #58a6ff30;
            border-left-color: #58a6ff;
        }

        .form-input {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #238636;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2ea043;
        }

        .btn-secondary {
            background-color: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #30363d;
            border-color: #8b949e;
        }

        .btn-gemini {
            background: linear-gradient(90deg, #4285F4, #9B72CB, #D96570, #F2A60C);
            color: white;
        }

        .btn-gemini:hover:not(:disabled) {
            opacity: 0.9;
        }

        /* Dynamic Background */
        .dynamic-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-color: #0d1117;
            overflow: hidden;
        }

        .dynamic-background .shape {
            position: absolute;
            list-style: none;
            display: block;
            width: 40px;
            height: 40px;
            background-color: rgba(88, 166, 255, 0.1);
            bottom: -150px;
            animation: animate 20s linear infinite;
        }

        .dynamic-background .shape:nth-child(1) {
            left: 10%;
            width: 80px;
            height: 80px;
            animation-delay: 0s;
        }

        .dynamic-background .shape:nth-child(2) {
            left: 20%;
            width: 30px;
            height: 30px;
            animation-delay: 1.5s;
            animation-duration: 10s;
        }

        .dynamic-background .shape:nth-child(3) {
            left: 25%;
            width: 100px;
            height: 100px;
            animation-delay: 5.5s;
        }

        .dynamic-background .shape:nth-child(4) {
            left: 40%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
            animation-duration: 15s;
        }

        .dynamic-background .shape:nth-child(5) {
            left: 65%;
            width: 40px;
            height: 40px;
            animation-delay: 0s;
        }

        .dynamic-background .shape:nth-child(6) {
            left: 75%;
            width: 110px;
            height: 110px;
            animation-delay: 3.5s;
        }

        .dynamic-background .shape:nth-child(7) {
            left: 85%;
            width: 70px;
            height: 70px;
            animation-delay: 7s;
            animation-duration: 8s;
        }

        @keyframes animate {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }

            100% {
                transform: translateY(-1000px) rotate(360deg);
                opacity: 0;
                border-radius: 50%;
            }
        }

        .recommendation-content h2,
        .explanation-content h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #30363d;
        }

        .recommendation-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #c9d1d9;
        }

        .recommendation-content ul {
            list-style-type: none;
            padding-left: 0.5rem;
            margin-top: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .recommendation-content li {
            margin-bottom: 0.75rem;
            padding-left: 1.25rem;
            position: relative;
            line-height: 1.6;
        }

        .recommendation-content li::before {
            content: '✓';
            color: #2ea043;
            position: absolute;
            left: 0;
            top: 4px;
            font-weight: bold;
        }

        .explanation-content p {
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #58a6ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .progress-bar {
            width: 300px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px auto;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #9B72CB);
            width: 0%;
            transition: width 2s ease-in-out;
        }

        /* New Splash/Login Styles */
        .login-card {
            background-color: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(48, 54, 61, 0.8);
        }

        /* AI Chat Styles */
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }

        .chat-message.user {
            background-color: #58a6ff;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.ai {
            background-color: rgba(48, 54, 61, 0.8);
            color: #c9d1d9;
        }

        .chat-typing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            color: #c9d1d9;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #58a6ff;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body class="h-screen">
    <div class="dynamic-background">
        <li class="shape"></li>
        <li class="shape"></li>
        <li class="shape"></li>
        <li class="shape"></li>
        <li class="shape"></li>
        <li class="shape"></li>
        <li class="shape"></li>
    </div>

    <div id="splash-view"
        class="fixed inset-0 bg-[#0d1117] flex flex-col items-center justify-center z-[100] transition-opacity duration-500">
        <div class="flex items-center space-x-4 mb-4">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L4 6V14C4 18.42 7.58 22.5 12 23.5C16.42 22.5 20 18.42 20 14V6L12 2Z" stroke="#58a6ff"
                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 14.5L9.5 13L7 14.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M17 9.5L14.5 11L12 9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M7 9.5L9.5 8L12 9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M12 14.5V9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M9.5 13V8" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M14.5 11V6" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
            <div>
                <h1 class="text-6xl font-black text-white tracking-tighter">GLucAI</h1>
                <p class="text-lg text-blue-400 font-semibold italic -mt-1">La IA que anticipa la diabetes.
                </p>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p class="text-sm text-gray-500 mt-4" id="loading-text">Cargando módulos... 0%</p>
    </div>

    <div id="login-view" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[90] hidden">
        <div class="login-card rounded-lg p-8 w-full max-w-sm text-center">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                class="mx-auto mb-4">
                <path d="M12 2L4 6V14C4 18.42 7.58 22.5 12 23.5C16.42 22.5 20 18.42 20 14V6L12 2Z" stroke="#58a6ff"
                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 14.5L9.5 13L7 14.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M17 9.5L14.5 11L12 9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M7 9.5L9.5 8L12 9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M12 14.5V9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M9.5 13V8" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M14.5 11V6" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
            <h2 class="text-2xl font-bold mb-2 text-white">Acceso para Profesionales</h2>
            <p class="text-gray-400 mb-6">Inicie sesión para acceder a su panel de pacientes.</p>

            <form id="login-form" class="space-y-4">
                <div>
                    <input type="text" id="login-user" placeholder="Usuario o Cédula Profesional" class="form-input"
                        required value="Dr. Rios">
                </div>
                <div>
                    <input type="password" id="login-password" placeholder="Contraseña" class="form-input" required
                        value="12345">
                </div>
                <button type="submit" class="w-full btn btn-primary mt-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Acceder a GLUCAI</span>
                </button>
            </form>
            <p id="login-error" class="text-red-400 text-sm mt-3 hidden">Credenciales incorrectas.</p>
        </div>
    </div>


    <div id="app-content" class="relative flex flex-col h-full hidden">
        <header class="flex-shrink-0 glass-pane flex items-center justify-between p-4 border-b border-gray-800">
            <div class="flex items-center space-x-4">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L4 6V14C4 18.42 7.58 22.5 12 23.5C16.42 22.5 20 18.42 20 14V6L12 2Z" stroke="#58a6ff"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 14.5L9.5 13L7 14.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M17 9.5L14.5 11L12 9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M7 9.5L9.5 8L12 9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M12 14.5V9.5" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M9.5 13V8" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M14.5 11V6" stroke="#58a6ff" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <div>
                    <h1 class="text-6xl font-black text-white tracking-tighter">GLucAI <span
                            class="text-xl text-blue-400 font-semibold align-middle">Versión: DEMO</span></h1>
                    <p class="text-sm text-gray-400 italic -mt-1">La IA que anticipa la diabetes.</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span id="doctor-display" class="text-right">
                    <p class="font-semibold text-white">Dr. Alejandro Ríos</p>
                    <p class="text-xs text-gray-500">Cardiólogo Metabólico - C.P. 1234567</p>
                </span>
                <button id="edit-doctor-btn"
                    class="p-2 text-gray-400 hover:text-white rounded-full hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                        <path fill-rule="evenodd"
                            d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="logout-btn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Salir</span>
                </button>
                <div
                    class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center border-2 border-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
        </header>

        <main class="flex-grow grid main-grid gap-4 p-4 overflow-hidden">
            <div class="glass-pane rounded-lg flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-gray-800 flex-shrink-0">
                    <h2 class="text-lg font-semibold text-white mb-2">Lista de Pacientes</h2>
                    <input type="text" id="search-patient" placeholder="Buscar paciente..." class="form-input">
                </div>
                <ul id="patient-list" class="flex-grow overflow-y-auto p-2">
                </ul>
                <div class="p-4 border-t border-gray-800 flex-shrink-0">
                    <button id="add-patient-btn" class="w-full btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        <span>Nuevo Paciente</span>
                    </button>
                </div>
            </div>

            <div id="details-panel" class="glass-pane rounded-lg h-full overflow-y-auto p-6">
                <div id="initial-state" class="flex flex-col items-center justify-center h-full text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-gray-600 mb-4" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="text-xl font-semibold text-white">Bienvenido a GLUCAI</h3>
                    <p class="text-gray-400 mt-2">Seleccione un paciente de la lista o agregue uno nuevo para comenzar
                        la evaluación de riesgo de Diabetes Tipo 2.</p>
                </div>

                <div id="patient-data-state" class="hidden">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 id="patient-name-header" class="text-2xl font-bold text-white">Nombre del Paciente</h3>
                            <p id="patient-details-subheader" class="text-gray-400">Edad, Género, Etnicidad</p>
                        </div>
                        <div id="action-buttons" class="flex items-center space-x-2">
                            <button id="pdf-report-btn" class="btn btn-secondary hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span>Reporte de Riesgo</span>
                            </button>
                            <button id="explain-risk-btn" class="btn btn-gemini hidden">
                                ✨ Explicar Riesgo
                            </button>
                            <button id="gemini-generate-btn" class="btn btn-gemini hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M10 3a1 1 0 011 1v1.5a.5.5 0 001 0V4a1 1 0 011-1h1.5a.5.5 0 000-1H13a1 1 0 01-1 1V1.5a.5.5 0 00-1 0V2a1 1 0 01-1 1H8.5a.5.5 0 000 1H10zM5.5 5a.5.5 0 000 1H7a1 1 0 011 1v1.5a.5.5 0 001 0V8a1 1 0 011-1h1.5a.5.5 0 000-1H10a1 1 0 01-1 1V5.5a.5.5 0 00-1 0V6a1 1 0 01-1 1H5.5zM15 10a.5.5 0 00-1 0v1.5a.5.5 0 01-1 0V10a.5.5 0 00-1 0v1.5a.5.5 0 01-1 0v-2a.5.5 0 00-1 0v2a.5.5 0 01-1 0V10a.5.5 0 00-1 0v1.5a.5.5 0 01-1 0V10a.5.5 0 00-1 0v4a1 1 0 001 1h6a1 1 0 001-1v-4z" />
                                </svg>
                                <span>Generar Plan IA</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-blue-300 border-b border-gray-700 pb-2">Parámetros de
                                Evaluación</h4>
                            <form id="patient-form" class="space-y-3">
                                <input type="hidden" id="patient-id">
                                <div>
                                    <label class="text-sm font-medium text-gray-400">Nombre Completo</label>
                                    <input type="text" id="patient-name" class="form-input mt-1">
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Edad</label>
                                        <input type="number" id="patient-age" class="form-input mt-1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Género</label>
                                        <select id="patient-gender" class="form-input mt-1">
                                            <option>Masculino</option>
                                            <option>Femenino</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Etnicidad</label>
                                        <select id="patient-ethnicity" class="form-input mt-1">
                                            <option>Caucásico</option>
                                            <option>Hispano</option>
                                            <option>Afroamericano</option>
                                            <option>Asiático</option>
                                            <option>Otro</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 pt-2">
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">IMC (kg/m²)</label>
                                        <input type="number" step="0.1" id="param-imc" class="form-input mt-1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Cintura (cm)</label>
                                        <input type="number" id="param-waist" class="form-input mt-1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Glucosa Ayunas (mg/dL)</label>
                                        <input type="number" id="param-glucose" class="form-input mt-1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">HbA1c (%)</label>
                                        <input type="number" step="0.1" id="param-hba1c" class="form-input mt-1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Presión Sistólica
                                            (mmHg)</label>
                                        <input type="number" id="param-sbp" class="form-input mt-1">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-400">Antecedentes Familiares</label>
                                        <select id="param-family" class="form-input mt-1">
                                            <option value="0">No</option>
                                            <option value="1">Sí</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="pt-4">
                                    <button type="submit" class="w-full btn btn-primary">Calcular Riesgo</button>
                                </div>
                            </form>
                        </div>

                        <div class="space-y-6">
                            <h4 class="text-lg font-semibold text-blue-300 border-b border-gray-700 pb-2">Diagnóstico
                                Asistido por IA</h4>
                            <div class="relative flex items-center justify-center h-64">
                                <canvas id="riskGaugeChart"></canvas>
                                <div id="risk-text" class="absolute text-center">
                                    <p class="text-4xl font-extrabold text-white">--</p>
                                    <p class="text-gray-400">Probabilidad</p>
                                </div>
                            </div>
                            <div>
                                <h5 class="font-semibold text-white mb-2">Factores Contribuyentes</h5>
                                <div class="h-64">
                                    <canvas id="factorChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="recommendation-section" class="mt-8 pt-6 border-t border-gray-700 hidden">
                        <div id="recommendation-loader" class="flex justify-center items-center h-32">
                            <div class="loader"></div>
                        </div>
                        <div id="recommendation-content" class="text-gray-300">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Assistant Chat -->
    <div id="ai-chat-btn" class="fixed bottom-6 right-6 z-40">
        <button class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full shadow-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        </button>
    </div>

    <div id="ai-chat-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="glass-pane rounded-lg p-6 w-full max-w-md h-[600px] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Asistente IA GlucAI
                </h2>
                <button id="close-ai-chat"
                    class="p-2 text-gray-400 hover:text-white rounded-full hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-2 bg-gray-900 rounded-lg">
                <div class="text-center text-gray-400 text-sm mb-4">¡Hola! Soy **GlucoBot**, tu asistente IA
                    especializado en diabetes. Puedo ayudarte con información sobre glucosa, dieta, ejercicio,
                    medicamentos y más. ¿En qué puedo ayudarte hoy?</div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <input type="text" id="chat-input" placeholder="Escribe tu mensaje..." class="form-input flex-grow">
                <button id="send-chat" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="doctor-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="glass-pane rounded-lg p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-white">Editar Información del Médico</h2>
            <form id="doctor-form" class="space-y-4">
                <div>
                    <label for="doctor-name" class="text-sm font-medium text-gray-400">Nombre Completo</label>
                    <input type="text" id="doctor-name" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="doctor-title" class="text-sm font-medium text-gray-400">Título / Especialidad</label>
                    <input type="text" id="doctor-title" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="doctor-license" class="text-sm font-medium text-gray-400">Cédula Profesional</label>
                    <input type="text" id="doctor-license" class="form-input mt-1" required>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-doctor-edit" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-patient-modal"
        class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="glass-pane rounded-lg p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-white">Agregar Nuevo Paciente</h2>
            <form id="add-patient-form" class="space-y-4">
                <div>
                    <label for="new-patient-name" class="text-sm font-medium text-gray-400">Nombre Completo</label>
                    <input type="text" id="new-patient-name" class="form-input mt-1" required>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="new-patient-age" class="text-sm font-medium text-gray-400">Edad</label>
                        <input type="number" id="new-patient-age" class="form-input mt-1" min="1" max="120" required>
                    </div>
                    <div>
                        <label for="new-patient-gender" class="text-sm font-medium text-gray-400">Género</label>
                        <select id="new-patient-gender" class="form-input mt-1" required>
                            <option value="">Seleccionar</option>
                            <option>Masculino</option>
                            <option>Femenino</option>
                        </select>
                    </div>
                    <div>
                        <label for="new-patient-ethnicity" class="text-sm font-medium text-gray-400">Etnicidad</label>
                        <select id="new-patient-ethnicity" class="form-input mt-1" required>
                            <option value="">Seleccionar</option>
                            <option>Caucásico</option>
                            <option>Hispano</option>
                            <option>Afroamericano</option>
                            <option>Asiático</option>
                            <option>Otro</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-add-patient" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Paciente</button>
                </div>
            </form>
        </div>
    </div>

    <div id="explanation-modal"
        class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="glass-pane rounded-lg p-8 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">✨ Explicación para el Paciente</h2>
                <button id="close-explanation-modal"
                    class="p-2 text-gray-400 hover:text-white rounded-full hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto pr-4">
                <div id="explanation-loader" class="flex justify-center items-center h-32">
                    <div class="loader"></div>
                </div>
                <div id="explanation-content" class="text-gray-300 explanation-content"></div>
            </div>
        </div>
    </div>


    <script>
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            // GLOBAL STATE
            let doctorInfo = {
                name: 'Dr. Alejandro Ríos',
                title: 'Cardiólogo Metabólico',
                license: '1234567'
            };
            const AUTH_KEY = 'glucai_demo_auth';

            // UI ELEMENTS
            const splashView = document.getElementById('splash-view');
            const loginView = document.getElementById('login-view');
            const appContent = document.getElementById('app-content');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            // --- VIEW MANAGEMENT FUNCTIONS ---

            const showApp = () => {
                loginView.classList.add('hidden');
                appContent.classList.remove('hidden');
                // Initialize all app components once content is visible
                renderPatientList();
                initCharts();
                updateDoctorDisplay();
                // Persist authentication
                sessionStorage.setItem(AUTH_KEY, 'true');
            };

            const showLogin = () => {
                // Ensure splash view is hidden before showing login
                splashView.classList.add('hidden');
                loginView.classList.remove('hidden');
            };

            const animateProgress = () => {
                const progressFill = document.getElementById('progress-fill');
                const loadingText = document.getElementById('loading-text');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 6; // Increase by 2% every 40ms for smooth animation over 2s
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                    }
                    progressFill.style.width = progress + '%';
                    loadingText.textContent = `Cargando módulos... ${progress}%`;
                }, 40);
            };

            const checkAuth = () => {
                if (sessionStorage.getItem(AUTH_KEY) === 'true') {
                    // Bypass login if previously authenticated
                    splashView.style.opacity = '0';
                    setTimeout(() => {
                        splashView.classList.add('hidden');
                        showApp();
                    }, 500); // Wait for fade-out
                } else {
                    // Show splash for 2 seconds, then transition to login
                    animateProgress(); // Start progress animation
                    setTimeout(() => {
                        splashView.style.opacity = '0';
                        setTimeout(showLogin, 500); // Transition to login after fade-out
                    }, 2000);
                }
            };

            // --- IMPROVED LOGIN LOGIC ---
            // Note: This is still client-side authentication, which is inherently insecure for production.
            // For production, implement server-side authentication with:
            // - HTTPS
            // - Password hashing with salt (e.g., bcrypt)
            // - JWT tokens or secure sessions
            // - Rate limiting on server
            // - CSRF protection for forms
            // - Input validation and sanitization on server
            // Hashed password for '12345' using SHA-256 (demo only)
            const VALID_USER = 'Dr. Rios';
            const VALID_PASS_HASH = '5994471abb01112afcc18159f6cc74b4f511b99806da59b3caf5a9c173cacfc5'; // SHA-256 of '12345'
            let failedAttempts = 0;
            const MAX_ATTEMPTS = 5;
            let lockoutTime = 0;

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();

                // Check if locked out
                if (Date.now() < lockoutTime) {
                    loginError.textContent = 'Demasiados intentos fallidos. Intente de nuevo en 5 minutos.';
                    loginError.classList.remove('hidden');
                    return;
                }

                const user = document.getElementById('login-user').value.trim();
                const pass = document.getElementById('login-password').value;

                // Input validation
                if (!user || !pass) {
                    loginError.textContent = 'Por favor, complete todos los campos.';
                    loginError.classList.remove('hidden');
                    return;
                }

                if (user.length > 100 || pass.length > 100) {
                    loginError.textContent = 'Entrada demasiado larga.';
                    loginError.classList.remove('hidden');
                    return;
                }

                // Hash the entered password
                const enteredHash = CryptoJS.SHA256(pass).toString();

                if (user === VALID_USER && enteredHash === VALID_PASS_HASH) {
                    loginError.classList.add('hidden');
                    failedAttempts = 0; // Reset on success
                    showApp();
                } else {
                    failedAttempts++;
                    if (failedAttempts >= MAX_ATTEMPTS) {
                        lockoutTime = Date.now() + 5 * 60 * 1000; // 5 minutes lockout
                        loginError.textContent = 'Demasiados intentos fallidos. Bloqueado por 5 minutos.';
                    } else {
                        loginError.textContent = `Credenciales incorrectas. Intentos restantes: ${MAX_ATTEMPTS - failedAttempts}`;
                    }
                    loginError.classList.remove('hidden');
                }
            });


            // --- EXISTING MOCK DATA AND FUNCTIONS (UNMODIFIED) ---
            const firstNames = ["Carlos", "Mariana", "Javier", "Sofía", "Luis", "Valentina", "Diego", "Camila", "Andrés", "Isabella"];
            const lastNames = ["García", "Rodríguez", "Martínez", "Hernández", "López", "González", "Pérez", "Sánchez", "Ramírez", "Flores"];
            let patients = [];
            for (let i = 1; i <= 50; i++) {
                patients.push({
                    id: i,
                    name: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                    age: Math.floor(Math.random() * 50) + 25,
                    gender: Math.random() > 0.5 ? 'Masculino' : 'Femenino',
                    ethnicity: ["Caucásico", "Hispano", "Afroamericano", "Asiático"][Math.floor(Math.random() * 4)],
                    params: {
                        imc: parseFloat((Math.random() * 20 + 20).toFixed(1)),
                        waist: Math.floor(Math.random() * 40 + 80),
                        glucose: Math.floor(Math.random() * 50 + 90),
                        hba1c: parseFloat((Math.random() * 2 + 5).toFixed(1)),
                        sbp: Math.floor(Math.random() * 50 + 110),
                        family: Math.random() > 0.7 ? 1 : 0
                    },
                    riskScore: null, riskCategory: 'PENDIENTE', recommendationText: ''
                });
            }

            // UI ELEMENTS (rest of them)
            const patientListEl = document.getElementById('patient-list');
            const searchInput = document.getElementById('search-patient');
            const initialStateEl = document.getElementById('initial-state');
            const patientDataStateEl = document.getElementById('patient-data-state');
            const form = document.getElementById('patient-form');
            const geminiBtn = document.getElementById('gemini-generate-btn');
            const pdfBtn = document.getElementById('pdf-report-btn');
            const explainRiskBtn = document.getElementById('explain-risk-btn');
            const recommendationSection = document.getElementById('recommendation-section');
            const recommendationLoader = document.getElementById('recommendation-loader');
            const recommendationContent = document.getElementById('recommendation-content');

            // Doctor Modal Elements
            const doctorModal = document.getElementById('doctor-modal');
            const editDoctorBtn = document.getElementById('edit-doctor-btn');
            const doctorForm = document.getElementById('doctor-form');
            const cancelDoctorEditBtn = document.getElementById('cancel-doctor-edit');
            const doctorDisplayEl = document.getElementById('doctor-display');

            // Add Patient Modal Elements
            const addPatientModal = document.getElementById('add-patient-modal');
            const addPatientBtn = document.getElementById('add-patient-btn');
            const addPatientForm = document.getElementById('add-patient-form');
            const cancelAddPatientBtn = document.getElementById('cancel-add-patient');

            // Explanation Modal Elements
            const explanationModal = document.getElementById('explanation-modal');
            const closeExplanationModalBtn = document.getElementById('close-explanation-modal');
            const explanationLoader = document.getElementById('explanation-loader');
            const explanationContent = document.getElementById('explanation-content');

            let riskGaugeChart, factorChart;
            const riskTextEl = document.getElementById('risk-text').querySelector('p:first-child');
            const riskColors = { BAJA: '#2ea043', MODERADA: '#f0ad4e', ALTA: '#d9534f', PENDIENTE: '#30363d' };
            const factorColors = ['#e60049', '#0bb4ff', '#50e991', '#e6d800', '#9b19f5', '#ffa300'];
            // Removed logoBase64 as it was incomplete and not used for PDF/Charts, which use native drawing.

            let selectedPatientId = null;

            // --- FUNCTION DEFINITIONS (omitted for brevity, assume original logic is here: updateDoctorDisplay, calculateRisk, getRiskCategory, initCharts, renderPatientList, selectPatient, generateRiskPDF, handleGeminiRequest) ---

            // --- The rest of the original JavaScript code goes here, including all the function definitions and event listeners. ---

            // Function updateDoctorDisplay
            function updateDoctorDisplay() {
                doctorDisplayEl.innerHTML = `
                    <p class="font-semibold text-white">${doctorInfo.name}</p>
                    <p class="text-xs text-gray-500">${doctorInfo.title} - C.P. ${doctorInfo.license}</p>
                `;
            }

            // Function getRiskCategory
            function getRiskCategory(score) {
                if (score === null) return 'PENDIENTE';
                if (score < 20) return 'BAJA';
                if (score < 50) return 'MODERADA';
                return 'ALTA';
            }

            // Function calculateRisk
            function calculateRisk(params) {
                // Simplified linear risk model for demo purposes (0-100 score)
                let score = 0;
                let contributions = {};

                // BMI (IMC): >30 is high risk
                let imcScore = Math.max(0, (params.imc - 25) * 2);
                score += imcScore;
                contributions.IMC = imcScore;

                // Waist (Cintura): >102 (M) / >88 (F) high risk (simplified for now)
                let waistScore = Math.max(0, (params.waist - 90) * 0.5);
                score += waistScore;
                contributions.Cintura = waistScore;

                // Fasting Glucose (Glucosa Ayunas): >100 impaired, >126 diabetic
                let glucoseScore = Math.max(0, (params.glucose - 100) * 0.8);
                score += glucoseScore;
                contributions.Glucosa = glucoseScore;

                // HbA1c: >5.7 pre-diabetic, >6.5 diabetic
                let hba1cScore = Math.max(0, (params.hba1c - 5.7) * 5);
                score += hba1cScore;
                contributions.HbA1c = hba1cScore;

                // SBP (Presión Sistólica): >130 high risk
                let sbpScore = Math.max(0, (params.sbp - 130) * 0.2);
                score += sbpScore;
                contributions.Presion = sbpScore;

                // Family History (Antecedentes Familiares)
                if (params.family === 1) {
                    score += 10;
                    contributions.Familia = 10;
                } else {
                    contributions.Familia = 0;
                }

                // Cap the score at 100
                score = Math.min(100, score);

                // Normalize contributions to sum up to 100% of the final risk score for the chart
                let totalContribution = Object.values(contributions).reduce((sum, val) => sum + val, 0);
                if (totalContribution > 0) {
                    for (const key in contributions) {
                        contributions[key] = (contributions[key] / totalContribution) * score;
                    }
                }

                return { score: parseFloat(score.toFixed(1)), contributions: contributions };
            }

            // Function initCharts
            function initCharts() {
                if (riskGaugeChart) riskGaugeChart.destroy();
                if (factorChart) factorChart.destroy();

                const gaugeCtx = document.getElementById('riskGaugeChart').getContext('2d');
                const factorCtx = document.getElementById('factorChart').getContext('2d');

                // Gauge Chart setup (Doughnut chart simulating a gauge)
                riskGaugeChart = new Chart(gaugeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Baja', 'Moderada', 'Alta', 'Relleno'],
                        datasets: [{
                            data: [20, 30, 50, 100], // Total sum is 100 (half circle) + 100 (invisible)
                            backgroundColor: [riskColors.BAJA, riskColors.MODERADA, riskColors.ALTA, 'transparent'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        rotation: 270, // Start at bottom
                        circumference: 180, // Half circle
                        cutout: '80%',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    },
                    plugins: [{
                        // Plugin to draw the needle (simplification, full needle requires complex drawing)
                        afterDraw: function (chart) {
                            // ... needle drawing logic (omitted for clean demo output) ...
                        }
                    }]
                });

                // Factor Chart setup (Bar Chart)
                factorChart = new Chart(factorCtx, {
                    type: 'bar',
                    data: {
                        labels: ['IMC', 'Cintura', 'Glucosa', 'HbA1c', 'Presion', 'Familia'],
                        datasets: [{
                            label: 'Puntuación de Riesgo por Factor',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: factorColors,
                            borderColor: '#30363d',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 50, // Max contribution visual
                                grid: { color: '#30363d' },
                                ticks: { color: '#c9d1d9' }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { color: '#c9d1d9' }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // Initial update for pending state
                updateCharts(null, {});
            }

            // Function updateCharts
            function updateCharts(score, contributions) {
                let category = getRiskCategory(score);
                riskTextEl.textContent = score !== null ? `${score}%` : '--';
                riskTextEl.style.color = score !== null ? riskColors[category] : '#c9d1d9';

                // Update Factor Chart
                if (factorChart) {
                    const contributionValues = factorChart.data.labels.map(label => contributions[label] || 0);
                    factorChart.data.datasets[0].data = contributionValues;
                    factorChart.update();
                }

                // Update Gauge Chart (Simulated)
                // In a real implementation, you'd update a needle's position based on the score.
            }


            // Function renderPatientList
            function renderPatientList(filter = '') {
                patientListEl.innerHTML = '';
                const filteredPatients = patients.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));

                if (filteredPatients.length === 0) {
                    patientListEl.innerHTML = '<li class="p-4 text-center text-gray-500">No se encontraron pacientes.</li>';
                    return;
                }

                filteredPatients.forEach(patient => {
                    const listItem = document.createElement('li');
                    const riskColor = riskColors[patient.riskCategory];
                    const activeClass = patient.id === selectedPatientId ? ' active' : '';

                    listItem.className = `patient-list-item flex justify-between items-center p-3 mb-2 rounded-md transition-colors cursor-pointer border-l-4 border-l-transparent${activeClass}`;
                    listItem.setAttribute('data-id', patient.id);
                    listItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${riskColor}; border: 1px solid ${riskColor === riskColors.PENDIENTE ? '#4b5563' : 'white'};"></span>
                            <div>
                                <p class="font-medium text-white">${patient.name}</p>
                                <p class="text-xs text-gray-400">${patient.age} años | ${patient.gender}</p>
                            </div>
                        </div>
                        <p class="text-sm font-semibold" style="color: ${riskColor};">${patient.riskCategory}</p>
                    `;

                    listItem.addEventListener('click', () => selectPatient(patient.id));
                    patientListEl.appendChild(listItem);
                });
            }

            // Function selectPatient
            function selectPatient(id) {
                const patient = patients.find(p => p.id === id);
                if (!patient) return;

                // Update active state in list
                document.querySelectorAll('.patient-list-item').forEach(el => el.classList.remove('active', 'border-l-[#58a6ff]'));
                const selectedEl = document.querySelector(`.patient-list-item[data-id="${id}"]`);
                if (selectedEl) {
                    selectedEl.classList.add('active', 'border-l-[#58a6ff]');
                }

                // Show details panel
                initialStateEl.classList.add('hidden');
                patientDataStateEl.classList.remove('hidden');
                selectedPatientId = id;

                // Populate header
                document.getElementById('patient-name-header').textContent = patient.name;
                document.getElementById('patient-details-subheader').textContent = `${patient.age} años | ${patient.gender} | ${patient.ethnicity}`;

                // Populate form
                document.getElementById('patient-id').value = patient.id;
                document.getElementById('patient-name').value = patient.name;
                document.getElementById('patient-age').value = patient.age;
                document.getElementById('patient-gender').value = patient.gender;
                document.getElementById('patient-ethnicity').value = patient.ethnicity;
                document.getElementById('param-imc').value = patient.params.imc;
                document.getElementById('param-waist').value = patient.params.waist;
                document.getElementById('param-glucose').value = patient.params.glucose;
                document.getElementById('param-hba1c').value = patient.params.hba1c;
                document.getElementById('param-sbp').value = patient.params.sbp;
                document.getElementById('param-family').value = patient.params.family;

                // Clear and hide recommendation section
                recommendationSection.classList.add('hidden');
                recommendationContent.innerHTML = '';
                document.getElementById('pdf-report-btn').classList.toggle('hidden', patient.riskScore === null);
                document.getElementById('explain-risk-btn').classList.toggle('hidden', patient.riskScore === null);
                document.getElementById('gemini-generate-btn').classList.toggle('hidden', patient.riskScore === null);

                // Update charts
                updateCharts(patient.riskScore, patient.riskScore ? patient.contributions : {});
            }

            // Function addNewPatient
            function addNewPatient(patientData) {
                const newId = patients.length + 1;
                const newPatient = {
                    id: newId,
                    name: patientData.name,
                    age: patientData.age,
                    gender: patientData.gender,
                    ethnicity: patientData.ethnicity,
                    params: {
                        imc: 0,
                        waist: 0,
                        glucose: 0,
                        hba1c: 0,
                        sbp: 0,
                        family: 0
                    },
                    riskScore: null,
                    riskCategory: 'PENDIENTE',
                    recommendationText: ''
                };

                patients.push(newPatient);
                renderPatientList(searchInput.value);
            }

            // Function handleFormSubmission
            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const currentPatient = patients.find(p => p.id === selectedPatientId);
                if (!currentPatient) return;

                // Gather data from form
                currentPatient.name = document.getElementById('patient-name').value;
                currentPatient.age = Number(document.getElementById('patient-age').value);
                currentPatient.gender = document.getElementById('patient-gender').value;
                currentPatient.ethnicity = document.getElementById('patient-ethnicity').value;
                currentPatient.params.imc = parseFloat(document.getElementById('param-imc').value);
                currentPatient.params.waist = Number(document.getElementById('param-waist').value);
                currentPatient.params.glucose = Number(document.getElementById('param-glucose').value);
                currentPatient.params.hba1c = parseFloat(document.getElementById('param-hba1c').value);
                currentPatient.params.sbp = Number(document.getElementById('param-sbp').value);
                currentPatient.params.family = Number(document.getElementById('param-family').value);

                // Calculate risk
                const { score, contributions } = calculateRisk(currentPatient.params);
                currentPatient.riskScore = score;
                currentPatient.riskCategory = getRiskCategory(score);
                currentPatient.contributions = contributions;

                // Update UI
                selectPatient(selectedPatientId); // Re-render everything to update status
                renderPatientList(searchInput.value); // Update list status

                // Show action buttons
                document.getElementById('pdf-report-btn').classList.remove('hidden');
                document.getElementById('explain-risk-btn').classList.remove('hidden');
                document.getElementById('gemini-generate-btn').classList.remove('hidden');

                alert(`Riesgo Calculado: ${currentPatient.riskCategory} (${currentPatient.riskScore}%)`);
            });

            // Function handleGeminiRequest (Simplified to show loading/content)
            geminiBtn.addEventListener('click', () => {
                const patient = patients.find(p => p.id === selectedPatientId);
                if (!patient || patient.riskScore === null) return;

                recommendationContent.innerHTML = '';
                recommendationLoader.classList.remove('hidden');
                recommendationSection.classList.remove('hidden');

                // Simulate Gemini API call delay
                setTimeout(() => {
                    const risk = patient.riskCategory;
                    const recommendations = {
                        ALTA: [
                            "Iniciar una dieta estricta baja en carbohidratos, priorizando vegetales y proteínas magras.",
                            "Monitorear la glucosa en ayunas y 2 horas postprandial diariamente.",
                            "Aumentar la actividad física a un mínimo de 150 minutos a la semana de ejercicio moderado.",
                            "Referencia inmediata a un especialista en Nutrición y Endocrinología para tratamiento farmacológico."
                        ],
                        MODERADA: [
                            "Implementar un plan de alimentación balanceado, reduciendo azúcares y grasas saturadas.",
                            "Establecer una rutina de ejercicio regular de al menos 30 minutos al día, 5 veces a la semana.",
                            "Control de peso con un objetivo de reducción del 5-7% del peso corporal actual.",
                            "Repetir los análisis de laboratorio (Glucosa y HbA1c) en 3 meses."
                        ],
                        BAJA: [
                            "Mantener hábitos de vida saludables: dieta mediterránea y ejercicio regular.",
                            "Fomentar la hidratación adecuada y el sueño reparador (7-8 horas).",
                            "Realizar un chequeo médico anual y mantener el monitoreo de glucosa cada 6 meses."
                        ]
                    };

                    let html = `<h2><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>Plan de Intervención Recomendado por IA (Riesgo ${risk})</h2>`;
                    html += `<h3>Recomendaciones Clave:</h3><ul>`;
                    recommendations[risk].forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    html += `</ul>`;

                    recommendationLoader.classList.add('hidden');
                    recommendationContent.innerHTML = html;
                    patient.recommendationText = html; // Save for PDF
                }, 1500);
            });

            // Function handleExplainRisk
            explainRiskBtn.addEventListener('click', () => {
                const patient = patients.find(p => p.id === selectedPatientId);
                if (!patient || patient.riskScore === null) return;

                explanationContent.innerHTML = '';
                explanationLoader.classList.remove('hidden');
                explanationModal.classList.remove('hidden');

                // Simulate Gemini API call delay for explanation
                setTimeout(() => {
                    const risk = patient.riskCategory;
                    const score = patient.riskScore;
                    let explanation = `<p>El sistema GLUCAI ha evaluado los parámetros de salud de **${patient.name}** y ha determinado un nivel de riesgo **${risk}** de desarrollar Diabetes Tipo 2 con una probabilidad del **${score}%**.</p>`;

                    explanation += `<p>Esta evaluación no es un diagnóstico final, sino una herramienta para la prevención temprana. El riesgo se basa en la combinación de varios factores biológicos y de estilo de vida.</p>`;

                    explanation += `<h2>Factores que Contribuyen a su Riesgo</h2>`;

                    if (patient.contributions.IMC > 0) explanation += `<p>**IMC (${patient.params.imc} kg/m²):** Un índice de masa corporal en el rango de sobrepeso u obesidad es un factor principal que aumenta la resistencia a la insulina.</p>`;
                    if (patient.contributions.Glucosa > 0) explanation += `<p>**Glucosa en Ayunas (${patient.params.glucose} mg/dL):** Su nivel de glucosa está por encima del rango óptimo, indicando una pre-diabetes o intolerancia a la glucosa.</p>`;
                    if (patient.contributions.Familia > 0) explanation += `<p>**Antecedentes Familiares:** La presencia de familiares con diabetes aumenta su predisposición genética a la enfermedad.</p>`;

                    explanationLoader.classList.add('hidden');
                    explanationContent.innerHTML = explanation;
                }, 1500);
            });


            // Function generateRiskPDF (Implementation using html2canvas/jspdf)
            async function generateRiskPDF(patient) {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // PDF dimensions
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;

                // Colors
                const primaryColor = [88, 166, 255]; // Blue
                const secondaryColor = [201, 209, 217]; // Light gray
                const riskColors = {
                    BAJA: [46, 160, 67],
                    MODERADA: [240, 173, 78],
                    ALTA: [217, 83, 79],
                    PENDIENTE: [48, 54, 61]
                };

                // Helper function to add text with word wrap
                const addWrappedText = (text, x, y, maxWidth, fontSize = 12) => {
                    pdf.setFontSize(fontSize);
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    pdf.text(lines, x, y);
                    return y + (lines.length * fontSize * 0.4);
                };

                // Helper function to add section header
                const addSectionHeader = (title, y) => {
                    pdf.setFillColor(...primaryColor);
                    pdf.rect(margin, y - 5, pageWidth - 2 * margin, 10, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(14);
                    pdf.text(title, margin + 5, y + 2);
                    pdf.setTextColor(0, 0, 0);
                    return y + 15;
                };

                try {
                    // Header
                    pdf.setFontSize(20);
                    pdf.setTextColor(...primaryColor);
                    pdf.text('GLucAI - Reporte de Riesgo de Diabetes', margin, yPosition);
                    yPosition += 15;

                    // Doctor and Date info
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Dr. ${doctorInfo.name} - ${doctorInfo.title}`, margin, yPosition);
                    pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, pageWidth - margin - 50, yPosition);
                    yPosition += 10;

                    // Patient Information Section
                    yPosition = addSectionHeader('Información del Paciente', yPosition);

                    pdf.setFontSize(12);
                    pdf.setTextColor(0, 0, 0);
                    const patientInfo = [
                        `Nombre: ${patient.name}`,
                        `Edad: ${patient.age} años`,
                        `Género: ${patient.gender}`,
                        `Etnicidad: ${patient.ethnicity}`
                    ];

                    patientInfo.forEach(info => {
                        pdf.text(info, margin, yPosition);
                        yPosition += 6;
                    });
                    yPosition += 5;

                    // Risk Assessment Section
                    yPosition = addSectionHeader('Evaluación de Riesgo', yPosition);

                    pdf.setFontSize(14);
                    pdf.setTextColor(...riskColors[patient.riskCategory]);
                    pdf.text(`Riesgo: ${patient.riskCategory} (${patient.riskScore}%)`, margin, yPosition);
                    yPosition += 10;

                    // Parameters Table
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    const params = patient.params;
                    const paramLabels = ['IMC (kg/m²)', 'Cintura (cm)', 'Glucosa Ayunas (mg/dL)', 'HbA1c (%)', 'Presión Sistólica (mmHg)', 'Antecedentes Familiares'];
                    const paramValues = [params.imc, params.waist, params.glucose, params.hba1c, params.sbp, params.family ? 'Sí' : 'No'];

                    // Table header
                    pdf.setFillColor(240, 240, 240);
                    pdf.rect(margin, yPosition - 3, pageWidth - 2 * margin, 8, 'F');
                    pdf.text('Parámetro', margin + 2, yPosition + 2);
                    pdf.text('Valor', pageWidth - margin - 30, yPosition + 2);
                    yPosition += 10;

                    // Table rows
                    paramLabels.forEach((label, index) => {
                        if (yPosition > pageHeight - 30) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(label, margin + 2, yPosition);
                        pdf.text(paramValues[index].toString(), pageWidth - margin - 30, yPosition);
                        yPosition += 6;
                    });
                    yPosition += 10;

                    // Charts Section
                    if (yPosition > pageHeight - 80) {
                        pdf.addPage();
                        yPosition = margin;
                    }
                    yPosition = addSectionHeader('Visualización de Riesgo', yPosition);

                    // Capture gauge chart
                    const gaugeCanvas = document.getElementById('riskGaugeChart');
                    if (gaugeCanvas) {
                        const gaugeImg = await html2canvas(gaugeCanvas, { scale: 2 });
                        const gaugeImgData = gaugeImg.toDataURL('image/png');
                        pdf.addImage(gaugeImgData, 'PNG', margin, yPosition, 80, 60);
                    }

                    // Capture factor chart
                    const factorCanvas = document.getElementById('factorChart');
                    if (factorCanvas) {
                        const factorImg = await html2canvas(factorCanvas, { scale: 2 });
                        const factorImgData = factorImg.toDataURL('image/png');
                        pdf.addImage(factorImgData, 'PNG', pageWidth - margin - 80, yPosition, 80, 60);
                    }
                    yPosition += 70;

                    // Recommendations Section
                    if (patient.recommendationText) {
                        if (yPosition > pageHeight - 50) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        yPosition = addSectionHeader('Recomendaciones de IA', yPosition);

                        // Clean HTML and convert to plain text
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = patient.recommendationText;
                        const plainText = tempDiv.textContent || tempDiv.innerText || '';

                        yPosition = addWrappedText(plainText, margin, yPosition, pageWidth - 2 * margin, 10);
                    }

                    // Footer
                    pdf.setFontSize(8);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('Este reporte es generado por GLucAI - IA para la prevención de Diabetes Tipo 2', margin, pageHeight - 10);
                    pdf.text('Versión DEMO - No constituye diagnóstico médico oficial', margin, pageHeight - 5);

                    // Save PDF
                    pdf.save(`reporte_riesgo_${patient.name.replace(/\s+/g, '_')}.pdf`);

                    alert('PDF generado exitosamente');

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error al generar el PDF. Revisa la consola para más detalles.');
                }
            }
            pdfBtn.addEventListener('click', async () => {
                const patient = patients.find(p => p.id == selectedPatientId);
                if (patient) await generateRiskPDF(patient);
            });

            // Doctor Modal Listeners
            editDoctorBtn.addEventListener('click', () => {
                document.getElementById('doctor-name').value = doctorInfo.name;
                document.getElementById('doctor-title').value = doctorInfo.title;
                document.getElementById('doctor-license').value = doctorInfo.license;
                doctorModal.classList.remove('hidden');
            });

            cancelDoctorEditBtn.addEventListener('click', () => {
                doctorModal.classList.add('hidden');
            });

            doctorForm.addEventListener('submit', (e) => {
                e.preventDefault();
                doctorInfo.name = document.getElementById('doctor-name').value;
                doctorInfo.title = document.getElementById('doctor-title').value;
                doctorInfo.license = document.getElementById('doctor-license').value;
                updateDoctorDisplay();
                doctorModal.classList.add('hidden');
            });

            // Add Patient Modal Listeners
            addPatientBtn.addEventListener('click', () => {
                addPatientModal.classList.remove('hidden');
            });

            cancelAddPatientBtn.addEventListener('click', () => {
                addPatientModal.classList.add('hidden');
                addPatientForm.reset();
            });

            addPatientForm.addEventListener('submit', (e) => {
                e.preventDefault();

                // Collect form data
                const newPatient = {
                    name: document.getElementById('new-patient-name').value.trim(),
                    age: parseInt(document.getElementById('new-patient-age').value),
                    gender: document.getElementById('new-patient-gender').value,
                    ethnicity: document.getElementById('new-patient-ethnicity').value
                };

                // Basic validation
                if (!newPatient.name || !newPatient.age || !newPatient.gender || !newPatient.ethnicity) {
                    alert('Por favor, complete todos los campos.');
                    return;
                }

                if (newPatient.age < 1 || newPatient.age > 120) {
                    alert('La edad debe estar entre 1 y 120 años.');
                    return;
                }

                // Add patient to array
                addNewPatient(newPatient);

                // Close modal and reset form
                addPatientModal.classList.add('hidden');
                addPatientForm.reset();

                alert(`Paciente "${newPatient.name}" agregado exitosamente.`);
            });

            // Explanation Modal Listeners
            closeExplanationModalBtn.addEventListener('click', () => {
                explanationModal.classList.add('hidden');
            });

            // AI Chat Elements
            const aiChatBtn = document.getElementById('ai-chat-btn');
            const aiChatModal = document.getElementById('ai-chat-modal');
            const closeAiChat = document.getElementById('close-ai-chat');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChat = document.getElementById('send-chat');

            // AI Chat Functions
            const addMessage = (text, type) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type}`;
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const showTyping = () => {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chat-typing';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>Asistente IA está escribiendo</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const hideTyping = () => {
                const typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();
            };

            // NOTA: Para respuestas más avanzadas, considera integrar una API de IA
            // Ejemplo con OpenAI (requiere servidor proxy para evitar exponer API key):
            /*
            const getAIResponseFromAPI = async (message) => {
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            context: 'diabetes management assistant'
                        })
                    });
                    const data = await response.json();
                    return data.response;
                } catch (error) {
                    return 'Lo siento, hay un problema con la conexión. Intenta de nuevo.';
                }
            };
            */
            // Por ahora usamos respuestas predefinidas para demo

            const getAIResponse = (message) => {
                const lowerMessage = message.toLowerCase().trim(); // Añadido .trim() para mejor manejo de espacios

                // --- Diccionario de respuestas para escalabilidad ---
                const responses = {
                    // Saludos y Ayuda General
                    'saludo': {
                        keywords: ['hola', 'saludo', 'buenos días', 'buenas tardes', 'qué tal', 'hey', 'hi', 'buenas'],
                        response: '¡Hola! 👋 Soy tu asistente IA **GlucoBot**, especializado en diabetes. ¿Cómo puedo ayudarte hoy con tu control o preguntas sobre esta condición?'
                    },
                    'ayuda': {
                        keywords: ['ayuda', 'qué puedes hacer', 'funciones', 'dudas', 'asistencia', 'qué sabes hacer', 'capacidades', 'qué haces', 'cómo me ayudas', 'qué servicios ofreces', 'qué me puedes decir', 'qué información tienes', 'qué sabes', 'qué conoces', 'de qué me hablas', 'qué temas manejas'],
                        response: '¡Claro! Como **GlucoBot**, tu asistente IA especializado en diabetes, puedo ayudarte con:\n\n• **Información médica básica**: Tipos de diabetes, síntomas, prevención.\n• **Control metabólico**: Glucosa, A1c, hipoglucemia, hiperglucemia.\n• **Estilo de vida**: Dieta saludable, ejercicio, manejo del peso.\n• **Tratamientos**: Medicamentos, insulina, planes de manejo.\n• **Evaluación de riesgo**: Interpretación de resultados de GLucAI.\n• **Consejos prácticos**: Monitoreo diario, días de enfermedad, autocuidado.\n• **Recursos oficiales**: Abrir guías del IMSS y documentos especializados.\n• **Controles de conversación**: Di "adiós" o "bye" para cerrar el chat.\n\n**Ejemplos de preguntas**: "¿Qué es la hipoglucemia?", "¿Cómo controlar mi dieta?", "¿Qué significa mi A1c?", "abrir guía IMSS".\n\n¿En qué tema específico te gustaría que te ayude?'
                    },

                    // --- Temas de Control Metabólico ---
                    'glucosa': {
                        keywords: ['glucosa', 'azúcar', 'niveles', 'monitoreo', 'control'],
                        response: 'La **glucosa en sangre** es tu métrica clave. Los niveles *normales en ayunas* son generalmente menores a 100 mg/dL. Revisa siempre tus *metas personalizadas* con tu médico. ¿Quieres saber sobre **hipoglucemia** o **hiperglucemia**?'
                    },
                    'a1c': {
                        keywords: ['a1c', 'hemoglobina glicosilada', 'promedio', 'hba1c'],
                        response: 'La **Hemoglobina Glicosilada (A1c)** es un promedio de tu glucosa en los últimos 2-3 meses. Para la mayoría de adultos con diabetes, la meta es **menos del 7%**. Un A1c más bajo se asocia con menos complicaciones. ¿Necesitas ayuda para entender tu resultado?'
                    },
                    'hipoglucemia': {
                        keywords: ['hipoglucemia', 'baja azúcar', 'me bajó', 'mareo', 'sintomas baja'],
                        response: 'La **hipoglucemia** (glucosa < 70 mg/dL) requiere acción inmediata. Usa la **Regla del 15**: consume 15 gramos de carbohidratos de acción rápida (como 1/2 taza de jugo), espera 15 minutos y vuelve a medir. Repite si es necesario. **¡Siempre avisa a un médico en casos graves!**'
                    },
                    'hiperglucemia': {
                        keywords: ['hiperglucemia', 'alta azúcar', 'me subió', 'mucha sed'],
                        response: 'La **hiperglucemia** (glucosa alta) puede causar fatiga, sed y micción frecuente. Si tu glucosa está consistentemente alta, ajusta tu **dieta, ejercicio y medicación** según las indicaciones de tu médico. **Nunca ajustes la insulina sin supervisión médica.**'
                    },

                    // --- Estilo de Vida y Manejo ---
                    'dieta': {
                        keywords: ['dieta', 'alimentación', 'comida', 'qué comer', 'carbohidratos'],
                        response: 'Una **dieta** amigable con la diabetes se centra en el **conteo de carbohidratos**, porciones controladas, y el consumo de fibra (vegetales, granos integrales). Prioriza proteínas magras. Evita las bebidas azucaradas. ¿Quieres una lista de *alimentos recomendados*?'
                    },
                    'ejercicio': {
                        keywords: ['ejercicio', 'actividad', 'deporte', 'caminar'],
                        response: 'El **ejercicio** ayuda a mejorar la sensibilidad a la insulina. Se recomiendan al menos **150 minutos** de actividad aeróbica moderada por semana y ejercicios de fuerza 2 días a la semana. ¡Consulta a tu médico sobre las precauciones antes de empezar!'
                    },
                    'medicamento': {
                        keywords: ['medicamento', 'insulina', 'metformina', 'tratamiento'],
                        response: 'Existen varios tratamientos: **Metformina** (primera línea), otros agentes orales e **Insulina**. Tu plan es *personalizado* por tu endocrinólogo o médico. **Nunca cambies tu dosis o medicamento sin consultarles.**'
                    },

                    // --- Otros Temas y Específicos de la App ---
                    'riesgo': {
                        keywords: ['riesgo', 'evaluación', 'glucai', 'prediabetes', 'prevención'],
                        response: '**GLucAI** evalúa el riesgo de diabetes Tipo 2. Los factores de riesgo incluyen **IMC alto, edad >45, sedentarismo y antecedentes familiares**. La **prediabetes** (glucosa alterada) es una señal de alerta. ¿Quieres saber cómo reducir el riesgo?'
                    },
                    'paciente': {
                        keywords: ['paciente', 'manejo', 'educación', 'autocuidado'],
                        response: 'El **manejo integral** implica **automonitoreo**, **educación** constante, **adherencia** al tratamiento y visitas regulares al equipo médico. El paciente es el *administrador principal* de su diabetes. ¿Necesitas información sobre cómo manejar una *enfermedad* (día de enfermo)?'
                    },

                    // --- Funciones Inteligentes ---
                    'abrir_pdf': {
                        keywords: ['abrir pdf', 'mostrar guía', 'guía imss', 'programa imss', 'pdf diabetes', 'documento oficial', 'normas imss'],
                        response: '¡Perfecto! Te abriré la **Guía de Práctica Clínica del IMSS** para la Prevención, Diagnóstico y Tratamiento de la Diabetes Mellitus. Esta es la guía oficial mexicana para el manejo de diabetes.',
                        action: 'openPDF'
                    },
                    'despedida': {
                        keywords: ['adiós', 'bye', 'chiao', 'chau', 'hasta luego', 'nos vemos', 'cerrar', 'salir'],
                        response: '¡Hasta luego! 👋 Fue un placer ayudarte con tus preguntas sobre diabetes. Si necesitas más información, estoy aquí para ayudarte.',
                        action: 'closeChat'
                    },
                };
                // ---------------------------------------------------

                // Bucle a través del diccionario para encontrar la mejor coincidencia
                for (const key in responses) {
                    if (responses.hasOwnProperty(key)) {
                        const { keywords, response: resText, action } = responses[key];
                        if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                            return { response: resText, action: action }; // Devuelve objeto con respuesta y acción
                        }
                    }
                }

                // Respuesta por defecto si no se encuentra ninguna coincidencia
                return {
                    response: 'Gracias por tu pregunta. Como asistente especializado en diabetes, me enfoco en temas relacionados con el manejo de esta condición. Si tu pregunta es sobre:\n\n• Control de glucosa y A1c\n• Alimentación y ejercicio\n• Medicamentos e insulina\n• Síntomas y complicaciones\n• Prevención y riesgo\n\nIntenta reformularla con palabras clave como "glucosa", "dieta", "ejercicio" o "ayuda".\n\nPara respuestas más naturales y completas, considera integrar una API de IA como OpenAI o Gemini en futuras versiones. ¿Quieres que te ayude con algún tema específico de diabetes?',
                    action: null
                };
            };

            const sendMessage = () => {
                const message = chatInput.value.trim();
                if (!message) return;

                addMessage(message, 'user');
                chatInput.value = '';

                showTyping();

                setTimeout(() => {
                    hideTyping();
                    const result = getAIResponse(message);
                    addMessage(result.response, 'ai');

                    // Execute action if present
                    if (result.action) {
                        if (result.action === 'openPDF') {
                            window.open('https://www.imss.gob.mx/sites/all/statics/profesionalesSalud/investigacionSalud/historico/programas/03-pai-dm-prevencion-diagnostico-y-tratamiento.pdf', '_blank');
                        } else if (result.action === 'closeChat') {
                            setTimeout(() => {
                                aiChatModal.classList.add('hidden');
                            }, 2000); // Wait 2 seconds before closing so user can see the goodbye message
                        }
                    }
                }, 1500 + Math.random() * 1000); // Random delay between 1.5-2.5s
            };

            // AI Chat Event Listeners
            aiChatBtn.addEventListener('click', () => {
                aiChatModal.classList.remove('hidden');
            });

            closeAiChat.addEventListener('click', () => {
                aiChatModal.classList.add('hidden');
            });

            sendChat.addEventListener('click', sendMessage);

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Search Listener
            searchInput.addEventListener('input', (e) => {
                renderPatientList(e.target.value);
            });


            // LOGOUT FUNCTIONALITY
            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem(AUTH_KEY);
                window.location.href = 'index.html';
            });

            // INITIALIZATION: Start the application flow
            checkAuth();
        });
    </script>
</body>




</html>